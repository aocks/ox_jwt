
#+BEGIN_SRC emacs-lisp :exports none
(require 'ox-reveal)

;; Make sure to use version 4.0 and set REVEAL_REVEAL_JS_VERSION below
(setq org-reveal-root "https://cdn.jsdelivr.net/npm/reveal.js@4.0.0/")
(setq org-reveal-plugins '(notes))
#+END_SRC

#+COMMENT: using timestamp:nil suppresses "created at" in title
#+COMMENT: using num:nil prevents slide titles being numbered
#+OPTIONS: timestamp:nil num:nil

#+REVEAL_REVEAL_JS_VERSION: 4
#+REVEAL_ROOT: https://cdn.jsdelivr.net/npm/reveal.js@4.0.0/
#+REVEAL_PLUGINS: (notes)
#+REVEAL_THEME: solarized
#+REVEAL_INIT_OPTIONS: fragments:true, transition:'fade'


#+COMMENT: Use `s` to engage speaker mode

#+TITLE: Tips, Tricks, and Reasons for JSON Web Tokens (JWTs)
#+AUTHOR: Emin Martinian

* Code Fragment Example :noexport:

#+BEGIN_SRC python
print("This appears immediately")
#+END_SRC

#+ATTR_REVEAL: :frag appear
#+BEGIN_SRC python
print("This appears after clicking")
#+END_SRC


* JWT: JSON Web Token

Used for authentication/authorization such as:

- front-end client to access back-end or API server
- compact, [[https://datatracker.ietf.org/doc/html/rfc7519][standardized]], secured, customizable
- "state-less" alternative to cookies/sessions
- scalable, performant, distributed trust


#+BEGIN_NOTES
- standard: [[https://datatracker.ietf.org/doc/html/rfc7519][RFC 7519]]
#+END_NOTES

* Why JWTs?

#+BEGIN_NOTES
- Auth server manages passwords, takes credit cards, etc.
- Must be secure and in sync; hard to load balance
- Cannot let just any employee have access
#+END_NOTES

Separate authentication from validation/application:
- Authentication requires secret keys (high security)
- Validation can use public key (less security)
- Easier to manage secrets, keys, load, sync, etc.

#+name: jwt-auth-vs-app-start
#+begin_src dot :cmdline -Kdot -Tjpg :exports results :file images/jwt-auth-vs-app-start.jpg

digraph auth_system {
    // Define subgraphs
    subgraph top {
        rank=same;
        AuthServer [label="Auth Server", shape=box];
        hidden [style=invis];
        AppServer [label="App Server", shape=box];
    }

    subgraph bottom {
        rank=same;
        Client [label="Client", shape=box];
    }

    // Define connections
    AuthServer -> Client [label="JWT", constraint=false, splines=ortho, style=invis];
    Client -> AuthServer [label="Authenticate\n(e.g., login\nor OAuth\nor credit card)", constraint=false, splines=ortho, style=invis];
    Client -> AppServer [label="Request Service\nusing JWT", constraint=false, splines=ortho,style=invis];

    // Define hidden edges to force layout
    AuthServer -> hidden [style=invis];
    hidden -> AppServer [style=invis];
    hidden -> Client [style=invis];
}

#+end_src

#+RESULTS: jwt-auth-vs-app-start
[[file:images/jwt-auth-vs-app-start.jpg]]


* JWT: Authentication Request

#+BEGIN_NOTES
Managing the authentication server is more complicated.
- Can't allow just anyone to access/maintain/deploy (has secrets)
- Must maintain state (e.g., current user password) so hard to load balance
#+END_NOTES


Client authenticates to server:

#+ATTR_REVEAL: :frag (appear appear)
- login with username/password/MFA
- may require database check, locks, other slow ops
- auth server must be secure


#+name: jwt-auth-vs-app-auth
#+begin_src dot :cmdline -Kdot -Tjpg :exports results :file images/jwt-auth-vs-app-auth.jpg

digraph auth_system {
    // Define subgraphs
    subgraph top {
        rank=same;
        AuthServer [label="Auth Server", shape=box];
        hidden [style=invis];
        AppServer [label="App Server", shape=box];
    }

    subgraph bottom {
        rank=same;
        Client [label="Client", shape=box];
    }

    // Define connections
    AuthServer -> Client [label="JWT", constraint=false, splines=ortho, style=invis];
    Client -> AuthServer [label="Authenticate\n(e.g., login\nor OAuth or\ncredit card)", constraint=false, splines=ortho];
    Client -> AppServer [label="Request Service\nusing JWT", constraint=false, splines=ortho,style=invis];

    // Define hidden edges to force layout
    AuthServer -> hidden [style=invis];
    hidden -> AppServer [style=invis];
    hidden -> Client [style=invis];
}

#+end_src

#+RESULTS: jwt-auth-vs-app-auth
[[file:images/jwt-auth-vs-app-auth.jpg]]


* JWT: Authentication Response

Server responds with JWT:

#+ATTR_REVEAL: :frag (appear appear)
- header describing JWT
- claims describing information/rights
- signature from Auth Server

#+name: jwt-auth-vs-app-auth-response
#+begin_src dot :cmdline -Kdot -Tjpg :exports results :file images/jwt-auth-vs-app-auth-response.jpg

digraph auth_system {
    // Define subgraphs
    subgraph top {
        rank=same;
        AuthServer [label="Auth Server", shape=box];
        hidden [style=invis];
        AppServer [label="App Server", shape=box];
    }

    subgraph bottom {
        rank=same;
        Client [label="Client", shape=box];
    }

    // Define connections
    AuthServer -> Client [label="JWT", constraint=false, splines=ortho];
    Client -> AuthServer [label="Authenticate\n(e.g., login\nor OAuth)", constraint=false, splines=ortho,style=invis];
    Client -> AppServer [label="Request Service\nusing JWT", constraint=false, splines=ortho,style=invis];

    // Define hidden edges to force layout
    AuthServer -> hidden [style=invis];
    hidden -> AppServer [style=invis];
    hidden -> Client [style=invis];
}

#+end_src

#+RESULTS: jwt-auth-vs-app-auth-response
[[file:images/jwt-auth-vs-app-auth-response.jpg]]


* JWT: Application Request

#+BEGIN_NOTES
- Distributed Trust
- App Server can be load balanced or serverless
- App Server can be maintained with lower security requirements
#+END_NOTES


Client sends JWT to App Server:

#+ATTR_REVEAL: :frag (appear appear)
- App Server validates JWT with public key
- No DB/state/sync/update; can be serverless
- Checks JWT for rights + provides service




#+name: jwt-auth-vs-app-request-app
#+begin_src dot :cmdline -Kdot -Tjpg :exports results :file images/jwt-auth-vs-app-request-app.jpg

digraph auth_system {
    // Define subgraphs
    subgraph top {
        rank=same;
        AuthServer [label="Auth Server", shape=box];
        hidden [style=invis];
        AppServer [label="App Server", shape=box];
    }

    subgraph bottom {
        rank=same;
        Client [label="Client", shape=box];
    }

    // Define connections
    AuthServer -> Client [label="JWT", constraint=false, splines=ortho,style=invis];
    Client -> AuthServer [label="Authenticate\n(e.g., login\nor OAuth)", constraint=false, splines=ortho,style=invis];
    Client -> AppServer [label="Send JWT to\nRequest Service", constraint=false, splines=ortho];

    // Define hidden edges to force layout
    AuthServer -> hidden [style=invis];
    hidden -> AppServer [style=invis];
    hidden -> Client [style=invis];
}

#+end_src

#+RESULTS: jwt-auth-vs-app-request-app
[[file:images/jwt-auth-vs-app-request-app.jpg]]





* Separate Auth From Validation

Auth Server has **secrets**; needs **security** + maintenance

#+ATTR_REVEAL: :frag (appear appear)
- App Server needs public keys; low security
- Easy to deploy App Server(s); e.g., serverless
- Lower security for App Server, logs, debug, etc.

#+name: jwt-auth-vs-app-separate
#+begin_src dot :cmdline -Kdot -Tjpg :exports results :file images/jwt-auth-vs-app-separate.jpg

digraph auth_system {
    // Define subgraphs
    subgraph top {
        rank=same;
        AuthServer [label="Auth Server", shape=box];
        hidden [style=invis];
        AppServer [label="App Server", shape=box];
    }

    subgraph bottom {
        rank=same;
        Client [label="Client", shape=box];
    }

    // Define connections
    AuthServer -> Client [label="JWT", constraint=false, splines=ortho,style=invis];
    Client -> AuthServer [label="Authenticate\n(e.g., login\nor OAuth)", constraint=false, splines=ortho,style=invis];
    Client -> AppServer [label="Send JWT to\nRequest Service", constraint=false, splines=ortho, style=invis];

    // Define hidden edges to force layout
    AuthServer -> hidden [style=invis];
    hidden -> AppServer [style=invis];
    hidden -> Client [style=invis];
}

#+end_src

#+RESULTS: jwt-auth-vs-app-separate
[[file:images/jwt-auth-vs-app-separate.jpg]]






* What do JWTs look like?

Base64 encoded header.payload.signature:

#+ATTR_REVEAL: :frag appear :frag_idx 1
#+BEGIN_src shell
HEADER:     { "alg": "HS256", "typ": "JWT" }
#+END_src

#+ATTR_REVEAL: :frag appear :frag_idx 2
#+BEGIN_src shell
PAYLOAD:    {"sub": "a", "name": "arbitrary data", "iat": 1 }
#+END_src

#+ATTR_REVEAL: :frag appear :frag_idx 3
#+BEGIN_src shell
SIGNATURE:  (depends on signing algorithm)
#+END_src

#+ATTR_REVEAL: :frag appear :frag_idx 4
- Signed using HS256 with secret=123:

#+ATTR_REVEAL: :frag appear :frag_idx 4
#+BEGIN_src shell
   eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
  .eyJzdWIiOiJhIiwibmFtZSI6ImIiLCJpYXQiOjF9
  .k4P2aZc9d0yYjaEXlHwl0e1PhNtmN1gLD9gtZvA59f4
#+END_src

#+BEGIN_NOTES
- Use https://jwt.io/#debugger-io to verify/validate/decode
#+END_NOTES

* Python/Flask Example

Easy to verify/decode using libraries (e.g., =pyjwt=) and compose
checks using decorators:

#+BEGIN_SRC python
@app.route('/support/urgent')
@requires_jwt                  # validates JWT
@jwt_claims(['premium_user'])  # ensures token is for premium user
@jwt_iat(datetime.timedelta(hours=24))  # ensure recent token
def support_urgent():
    ... # process ending support request
#+END_SRC

* Example of =@requires_jwt=

#+BEGIN_SRC python
def requires_jwt(func):
    @wraps(func)
    def decorated(*args, **kwargs):        
        token = request.headers.get("Authorization").split(" ")[1]
        if not token:
            return 'missing token', 401  # if no token return error   
        try:
            g.decoded_jwt = jwt.decode(token, algorithms=['ES256'],
                                       key=current_app.config['J_KEY'])
            check_nbf_and_exp()  # ensure active and not expired
            return func(*args, **kwargs)
        except Exception as problem:
            return f'{problem=}', 401 # return 401 or other error code
    return decorated
#+END_SRC

* Example of =@jwt_claims=

#+COMMENT: should we include or skip if tight on time?
#+COMMENT: or maybe have as backup slide

#+BEGIN_SRC python
def jwt_claims(claims_list):
    def make_decorator(func):
        @wraps(func)
        def decorated(*args, **kwargs):        
            missing = [c for c in claims_list if not g.decoded_jwt.get(c)]
            if missing:
                return f'Missing claims: {missing}', 401
            return func(*args, **kwargs)
        return decorated
    return make_decorator
#+END_SRC

* Separate validation from parsing

Can use middleware to verify signature

- slow/expensive for public keys or even secure symmetric keys
- e.g., NGINX can verify before passing to app server

* Traps, Vulnerabilities, and Anti-Patterns

#+ATTR_REVEAL: :frag (appear appear appear)
- Beware of using header fields in checking signature
  - don't trust =alg= field or limit possibilities
  - be careful with =kid=, =jku=, =jwk=, etc.
- Don't simulate sessions with JWTs
- Token revocation issue: access/refresh tokens


* Revocation via Access/Refresh Tokens

After initial credential check (e.g., username/password or API
key/secret), Auth server provides:

- "refresh token" with long expiry
  - can be used to get access token without credential check
- "access token" with short expiry
  - can be used to access services

On security events (role changes, credential changes, hacks), auth
server will invalidate refresh token + require new credential check.

* Summary and next steps

#+BEGIN_NOTES
If you are writing a small application, you can quickly and easily put
together a secure system using various JWT libraries.

If you are doing a full enterprise authentication system, you may want
to go with an existing platform. Many of those use JWTs under the hood
so it's still useful to have a high level understanding of the basic diea.
#+END_NOTES

#+ATTR_REVEAL: :frag (none none none appear appear)
- Distributed trust can enable many use cases
- JWTs = secure, efficient, standardized auth tool
- Python decorators = nice way to validate claims
- Libraries:
  - [[https://pyjwt.readthedocs.io/en/stable/][pyjwt]], [[https://flask-jwt-extended.readthedocs.io/en/stable/][flask-jwt-extended]], [[https://django-rest-framework-simplejwt.readthedocs.io/en/latest/][djangorestframework-simplejwt]]
- Platforms:
  - [[https://auth0.com][auth0]], [[https://supertokens.com/][supertokens]], [[https://aws.amazon.com/cognito/][cognito]], [[https://www.keycloak.org/][keycloak]]







